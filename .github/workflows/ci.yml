name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  test:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        node-version: [18.x, 20.x]

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Setup Bun
      uses: oven-sh/setup-bun@v1
      with:
        bun-version: latest

    - name: Install dependencies
      run: bun install

    - name: Setup Husky
      run: bun run prepare

    - name: Check for Base44 usage
      run: bun run migrate:check

    - name: Run linter
      run: bun run lint

    - name: Run tests
      run: bun run test

    - name: Build application
      run: bun run build

  migration-validation:
    runs-on: ubuntu-latest
    needs: test

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Bun
      uses: oven-sh/setup-bun@v1
      with:
        bun-version: latest

    - name: Install dependencies
      run: bun install

    - name: Scan for migration opportunities
      run: bun run migrate:scan

    - name: Validate migration status
      run: bun run migrate:stats

  deploy-staging:
    runs-on: ubuntu-latest
    needs: [test, migration-validation]
    if: github.ref == 'refs/heads/develop'

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Bun
      uses: oven-sh/setup-bun@v1
      with:
        bun-version: latest

    - name: Install dependencies
      run: bun install

    - name: Build for staging
      run: bun run build
      env:
        NODE_ENV: staging

    - name: Deploy to staging
      run: |
        echo "Deploying to staging environment..."
        # Add your staging deployment commands here

  deploy-production:
    runs-on: ubuntu-latest
    needs: [test, migration-validation]
    if: github.ref == 'refs/heads/main'

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Bun
      uses: oven-sh/setup-bun@v1
      with:
        bun-version: latest

    - name: Install dependencies
      run: bun install

    - name: Build for production
      run: bun run build
      env:
        NODE_ENV: production

    - name: Run migration checks
      run: |
        echo "Running final migration validation..."
        bun run migrate:check

    - name: Deploy to production
      run: |
        echo "Deploying to production environment..."
        # Add your production deployment commands here

  migration-report:
    runs-on: ubuntu-latest
    needs: [test, migration-validation]
    if: always()

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Bun
      uses: oven-sh/setup-bun@v1
      with:
        bun-version: latest

    - name: Generate migration report
      run: |
        echo "## Migration Status Report" > migration-report.md
        echo "" >> migration-report.md
        echo "### Base44 Usage Scan:" >> migration-report.md
        bun run migrate:scan >> migration-report.md 2>&1 || true
        echo "" >> migration-report.md
        echo "### Migration Statistics:" >> migration-report.md
        bun run migrate:stats >> migration-report.md 2>&1 || true

    - name: Upload migration report
      uses: actions/upload-artifact@v4
      with:
        name: migration-report
        path: migration-report.md