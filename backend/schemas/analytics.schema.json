{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "title": "Compilar Analytics Database Schema",
  "description": "User analytics, session tracking, and AI conversation data",
  "version": "1.0.0",

  "tables": {
    "coach_conversations": {
      "description": "AI coaching conversation history and context",
      "columns": {
        "id": {
          "type": "uuid",
          "default": "uuid_generate_v4()",
          "primary_key": true
        },
        "user_id": {
          "type": "uuid",
          "references": "auth.users(id)",
          "not_null": true,
          "on_delete": "CASCADE"
        },
        "session_id": {
          "type": "uuid",
          "references": "assessment_sessions(id)",
          "on_delete": "CASCADE",
          "description": "Related assessment session"
        },
        "messages": {
          "type": "jsonb",
          "default": "[]",
          "not_null": true,
          "description": "Conversation message history"
        },
        "context": {
          "type": "jsonb",
          "default": "{}",
          "description": "Conversation context data"
        },
        "created_at": {
          "type": "timestamp with time zone",
          "default": "NOW()",
          "not_null": true
        },
        "updated_at": {
          "type": "timestamp with time zone",
          "default": "NOW()",
          "not_null": true
        }
      },
      "indexes": ["user_id", "session_id"],
      "triggers": ["updated_at"],
      "rls_policies": [
        "Users can view their own conversations",
        "Users can create their own conversations",
        "Users can update their own conversations"
      ]
    },

    "user_analytics": {
      "description": "User behavior and interaction analytics",
      "columns": {
        "id": {
          "type": "uuid",
          "default": "uuid_generate_v4()",
          "primary_key": true
        },
        "user_id": {
          "type": "uuid",
          "references": "auth.users(id)",
          "not_null": true,
          "on_delete": "CASCADE"
        },
        "event_type": {
          "type": "text",
          "not_null": true,
          "description": "Type of user event"
        },
        "event_data": {
          "type": "jsonb",
          "default": "{}",
          "description": "Event-specific data"
        },
        "session_id": {
          "type": "text",
          "description": "Browser session identifier"
        },
        "page_url": {
          "type": "text",
          "description": "Page URL where event occurred"
        },
        "user_agent": {
          "type": "text",
          "description": "Browser user agent"
        },
        "ip_address": {
          "type": "inet",
          "description": "User IP address"
        },
        "created_at": {
          "type": "timestamp with time zone",
          "default": "NOW()",
          "not_null": true
        }
      },
      "indexes": ["user_id", "event_type", "created_at"],
      "rls_policies": [
        "Users can view their own analytics",
        "System can create user analytics"
      ]
    },

    "session_analytics": {
      "description": "Assessment session performance and quality metrics",
      "columns": {
        "id": {
          "type": "uuid",
          "default": "uuid_generate_v4()",
          "primary_key": true
        },
        "user_id": {
          "type": "uuid",
          "references": "auth.users(id)",
          "not_null": true,
          "on_delete": "CASCADE"
        },
        "session_id": {
          "type": "uuid",
          "references": "assessment_sessions(id)",
          "not_null": true,
          "on_delete": "CASCADE"
        },
        "duration_seconds": {
          "type": "integer",
          "description": "Session duration in seconds"
        },
        "completion_rate": {
          "type": "decimal(5,2)",
          "description": "Session completion percentage"
        },
        "interaction_count": {
          "type": "integer",
          "default": 0,
          "description": "Number of user interactions"
        },
        "pillar_focus": {
          "type": "text",
          "description": "Primary pillar assessed"
        },
        "mode": {
          "type": "text",
          "enum": ["egalitarian", "hierarchical"],
          "description": "Assessment mode"
        },
        "quality_score": {
          "type": "decimal(3,2)",
          "description": "Overall session quality score"
        },
        "created_at": {
          "type": "timestamp with time zone",
          "default": "NOW()",
          "not_null": true
        }
      },
      "indexes": ["user_id", "session_id"],
      "rls_policies": [
        "Users can view their own session analytics",
        "System can create session analytics"
      ]
    }
  }
}